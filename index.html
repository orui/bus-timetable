<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="æ™´æµ·ãƒã‚¹">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>æ™´æµ·ãƒã‚¹æ™‚åˆ»è¡¨</title>
<style>
  :root {
    --primary: #1a73e8;
    --primary-light: #e8f0fe;
    --accent: #ea4335;
    --green: #00897b;
    --green-light: #e0f2f1;
    --orange: #f9ab00;
    --bg: #f8f9fa;
    --card: #fff;
    --text: #202124;
    --sub: #5f6368;
    --border: #e0e0e0;
    --radius: 16px;
    --liner: #1a73e8;
    --brt: #00897b;
    --shuttle: #e67c00;
    --shuttle-light: #fff3e0;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
  }
  header {
    background: linear-gradient(135deg, #1a3a5c, #1a73e8);
    color: #fff;
    padding: 14px 20px;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  header h1 { font-size: 17px; font-weight: 600; }
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .day-badge {
    font-size: 12px;
    padding: 3px 10px;
    border-radius: 20px;
    background: rgba(255,255,255,.2);
    font-weight: 500;
  }
  .container {
    max-width: 480px;
    margin: 0 auto;
    padding: 16px;
  }

  /* Hero */
  .hero {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px 24px;
    text-align: center;
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }
  .hero-accent { position: absolute; top: 0; left: 0; right: 0; height: 4px; }
  .hero-accent.liner { background: var(--liner); }
  .hero-accent.brt { background: var(--brt); }
  .hero-accent.shuttle, .hero-accent.tiaro { background: var(--shuttle); }
  .hero-label {
    font-size: 13px;
    color: var(--sub);
    margin-bottom: 2px;
  }
  .hero-time {
    font-size: 52px;
    font-weight: 700;
    letter-spacing: -2px;
    color: var(--text);
    line-height: 1.1;
  }
  .hero-wait {
    display: inline-block;
    margin-top: 6px;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    background: var(--primary-light);
    padding: 3px 14px;
    border-radius: 20px;
  }
  .hero-wait.urgent { color: #fff; background: var(--accent); animation: pulse 1.5s infinite; }
  .hero-wait.soon { color: #fff; background: var(--orange); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
  .hero-service {
    display: inline-block;
    margin-top: 6px;
    font-size: 12px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 4px;
  }
  .hero-service.liner { background: var(--primary-light); color: var(--liner); }
  .hero-service.brt { background: var(--green-light); color: var(--brt); }
  .hero-service.shuttle, .hero-service.tiaro { background: var(--shuttle-light); color: var(--shuttle); }
  .hero-dest {
    font-size: 12px;
    color: var(--sub);
    margin-top: 4px;
  }
  .hero-next-day {
    font-size: 12px;
    color: var(--sub);
    margin-top: 4px;
  }
  .now-clock {
    font-size: 13px;
    color: var(--sub);
    margin-top: 8px;
  }

  /* Upcoming */
  .section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--sub);
    margin: 20px 0 8px;
    padding-left: 4px;
  }
  .upcoming {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
    overflow: hidden;
  }
  .upcoming-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    gap: 10px;
  }
  .upcoming-item:last-child { border-bottom: none; }
  .upcoming-svc {
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 3px;
    white-space: nowrap;
    width: 46px;
    text-align: center;
    flex-shrink: 0;
  }
  .upcoming-svc.liner { background: var(--primary-light); color: var(--liner); }
  .upcoming-svc.brt { background: var(--green-light); color: var(--brt); }
  .upcoming-svc.shuttle, .upcoming-svc.tiaro { background: var(--shuttle-light); color: var(--shuttle); }
  .upcoming-time {
    font-size: 20px;
    font-weight: 600;
    width: 58px;
    flex-shrink: 0;
  }
  .upcoming-dest {
    font-size: 11px;
    color: var(--sub);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .upcoming-wait {
    font-size: 14px;
    font-weight: 500;
    color: var(--sub);
    white-space: nowrap;
    text-align: right;
    flex-shrink: 0;
  }
  .no-bus {
    padding: 24px;
    text-align: center;
    color: var(--sub);
    font-size: 14px;
  }

  /* Timetable tabs */
  .tabs {
    display: flex;
    gap: 8px;
    margin: 20px 0 10px;
  }
  .tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: var(--card);
    color: var(--sub);
    box-shadow: 0 1px 3px rgba(0,0,0,.06);
    transition: all .2s;
  }
  .tab.active { color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
  .tab.active[data-type="weekday"],
  .tab.active[data-type="weekend"] { background: #444; }

  /* Timetable */
  .timetable-section {
    margin-bottom: 16px;
  }
  .tt-header {
    font-size: 13px;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: var(--radius) var(--radius) 0 0;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tt-header.liner { background: var(--liner); }
  .tt-header.brt { background: var(--brt); }
  .tt-header.shuttle, .tt-header.tiaro { background: var(--shuttle); }
  .tt-header .dest-note {
    font-weight: 400;
    font-size: 11px;
    opacity: .8;
  }
  .timetable {
    background: var(--card);
    border-radius: 0 0 var(--radius) var(--radius);
    box-shadow: 0 1px 4px rgba(0,0,0,.08);
    overflow: hidden;
  }
  .tt-row {
    display: flex;
    align-items: baseline;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
  }
  .tt-row:last-child { border-bottom: none; }
  .tt-row.past { opacity: .55; }
  .tt-row.current-liner { background: var(--primary-light); }
  .tt-row.current-brt { background: var(--green-light); }
  .tt-row.current-shuttle, .tt-row.current-tiaro { background: var(--shuttle-light); }
  .tt-hour {
    font-size: 16px;
    font-weight: 700;
    width: 32px;
    flex-shrink: 0;
  }
  .tt-hour.liner { color: var(--liner); }
  .tt-hour.brt { color: var(--brt); }
  .tt-hour.shuttle, .tt-hour.tiaro { color: var(--shuttle); }
  .tt-minutes {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    flex: 1;
  }
  .tt-min {
    font-size: 14px;
    font-weight: 500;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all .2s;
    position: relative;
  }
  .tt-min.past { color: #888; }
  .tt-min.next-liner {
    background: var(--liner);
    color: #fff;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(26,115,232,.3);
    animation: pop .4s ease;
  }
  .tt-min.next-brt {
    background: var(--brt);
    color: #fff;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(0,137,123,.3);
    animation: pop .4s ease;
  }
  .tt-min.next-shuttle, .tt-min.next-tiaro {
    background: var(--shuttle);
    color: #fff;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(230,124,0,.3);
    animation: pop .4s ease;
  }
  .tt-min.future { color: var(--text); }
  .tt-min.special { border: 2px solid #e57373; }
  .tt-min.special.next-liner,
  .tt-min.special.next-brt,
  .tt-min.special.next-shuttle,
  .tt-min.special.next-tiaro { border-color: transparent; }
  @keyframes pop { 0%{transform:scale(.6)} 60%{transform:scale(1.1)} 100%{transform:scale(1)} }

  .legend {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    padding: 8px 16px;
    font-size: 11px;
    color: var(--sub);
    border-bottom: 1px solid var(--border);
  }
  .legend-item { display: flex; align-items: center; gap: 4px; }
  .legend-dot {
    width: 10px; height: 10px;
    border-radius: 50%; flex-shrink: 0;
  }

  /* Time picker */
  .time-picker {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 12px;
  }
  .time-picker label {
    font-size: 12px;
    color: var(--sub);
  }
  .time-picker input[type="time"],
  .time-picker input[type="date"] {
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    color: var(--text);
    outline: none;
  }
  .time-picker input[type="time"]:focus,
  .time-picker input[type="date"]:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--primary-light);
  }
  .time-picker .btn-now {
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: var(--primary);
    color: #fff;
    transition: opacity .2s;
  }
  .time-picker .btn-now:active { opacity: .7; }
  .time-picker .btn-now.hidden { display: none; }
  .sim-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    background: #fce8e6;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 6px;
  }
  .sim-badge.hidden { display: none; }

  .footer {
    text-align: center;
    font-size: 11px;
    color: #aaa;
    padding: 24px 0 40px;
  }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
    :root {
      --bg-color: #ffffff;
      --text-color: #333333;
      --card-bg: #f8f9fa;
      --border-color: #dee2e6;
      --accent-color: #007bff;
    }
    
    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #e9ecef;
      --card-bg: #2d2d2d;
      --border-color: #495057;
      --accent-color: #4dabf7;
    }
    
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .card, .btn, input, select {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: var(--border-color);
    }
    
    .btn-primary {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
      z-index: 1000;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
    }
    
    /* ãŠæ°—ã«å…¥ã‚Šåœç•™æ‰€ */
    .favorites-panel {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    
    .favorites-panel.show {
      display: block;
    }
    
    .favorites-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .favorites-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .favorite-item {
      background: var(--accent-color);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .favorite-item:hover {
      background: var(--accent-color);
      opacity: 0.8;
      color: white;
      text-decoration: none;
    }
    
    .favorite-item .remove-btn {
      margin-left: 8px;
      opacity: 0.7;
      cursor: pointer;
    }
    
    .favorite-item .remove-btn:hover {
      opacity: 1;
    }
    
    .add-favorite-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--accent-color);
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }
    
    .add-favorite-btn:hover {
      opacity: 1;
    }
    
  /* é€šçŸ¥æ©Ÿèƒ½ */
  .notification-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 15px;
    min-width: 280px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transform: translateX(320px);
    transition: transform 0.3s ease;
    z-index: 1000;
  }
  
  .notification-panel.show {
    transform: translateX(0);
  }
  
  .notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .notification-setting {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .notify-toggle {
    position: fixed;
    bottom: 20px;
    right: 80px;
    background: var(--accent-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s ease;
    z-index: 999;
  }
  
  .notify-toggle:hover {
    transform: scale(1.1);
  }
  
  .notify-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .notification-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent-color);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    font-weight: bold;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .notification-toast.show {
    opacity: 1;
  }
  
  .time-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .time-input {
    flex: 1;
    padding: 5px 8px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background: var(--card-bg);
    color: var(--text-color);
  }
  
  /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¼·åŒ– */
  
  /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤ºã®æ”¹å–„ */
  *:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
  }
  
  /* ãƒœã‚¿ãƒ³ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ */
  button:focus,
  .btn:focus {
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
  }
  
  /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .keyboard-navigation .focusable:focus {
    background-color: var(--accent-color);
    color: white;
    transform: scale(1.05);
  }
  
  /* é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
  @media (prefers-contrast: high) {
    :root {
      --text-color: #000000;
      --bg-color: #ffffff;
      --border-color: #000000;
    }
    
    [data-theme="dark"] {
      --text-color: #ffffff;
      --bg-color: #000000;
      --border-color: #ffffff;
    }
    
    button, .btn {
      border-width: 2px;
    }
  }
  
  /* å‹•ãã‚’æ¸›ã‚‰ã™è¨­å®šã¸ã®å¯¾å¿œ */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
  
  /* å¤§ããªãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¯¾å¿œ */
  @media (min-width: 1200px) {
    .large-text body {
      font-size: 18px;
    }
    
    .large-text .btn {
      padding: 12px 24px;
      font-size: 16px;
    }
    
    .large-text .theme-toggle,
    .large-text .notify-toggle {
      width: 60px;
      height: 60px;
      font-size: 24px;
    }
  }
  
  /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å°‚ç”¨ãƒ†ã‚­ã‚¹ãƒˆ */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  /* éŸ³å£°èª­ã¿ä¸Šã’ã®ãŸã‚ã®æ”¹å–„ */
  .bus-time {
    speak: literal;
  }
  
  .status-text {
    aria-live: polite;
  }
  
  /* ã‚«ãƒ©ãƒ¼ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .color-blind-friendly {
    /* è‰²ã ã‘ã§ãªãå½¢ã‚„ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚æƒ…å ±ã‚’ä¼ãˆã‚‹ */
  }
  
  .status-ok::before { content: "âœ… "; }
  .status-warning::before { content: "âš ï¸ "; }
  .status-error::before { content: "âŒ "; }
  
  /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®šãƒ‘ãƒãƒ« */
  .accessibility-panel {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%) translateX(320px);
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 20px;
    min-width: 300px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    z-index: 1000;
  }
  
  .accessibility-panel.show {
    transform: translateY(-50%) translateX(0);
  }
  
  .accessibility-toggle {
    position: fixed;
    bottom: 20px;
    right: 140px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s ease;
    z-index: 999;
  }
  
  .accessibility-toggle:hover {
    transform: scale(1.1);
  }
  
  .accessibility-setting {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid transparent;
  }
  
  .accessibility-setting:hover,
  .accessibility-setting:focus-within {
    background-color: var(--card-bg);
    border-color: var(--border-color);
  }
  
  /* éŸ³å£°èª­ã¿ä¸Šã’å¯¾å¿œ */
  .speak-button {
    background: none;
    border: none;
    color: var(--accent-color);
    cursor: pointer;
    font-size: 16px;
    margin-left: 10px;
  }
  </style>
</head>
<body>

<header>
  <div class="header-row">
    <h1>ğŸšŒ æ™´æµ·ãƒã‚¹æ™‚åˆ»è¡¨</h1>
    <span class="day-badge" id="dayBadge"></span>
  </div>
</header>

<div class="container">
  <div class="time-picker">
    <label>æ—¥æ™‚æŒ‡å®š</label>
    <input type="date" id="simDate" onchange="onSimChange()">
    <input type="time" id="simTime" onchange="onSimChange()">
    <button class="btn-now hidden" id="btnNow" onclick="clearSim()">ç¾åœ¨ã«æˆ»ã™</button>
  </div>

  <div class="hero">
    <div class="hero-accent" id="heroAccent"></div>
    <div class="hero-label">æ¬¡ã®ãƒã‚¹<span class="sim-badge hidden" id="simBadge">æŒ‡å®šæ™‚åˆ»</span></div>
    <div class="hero-time" id="nextTime">--:--</div>
    <div class="hero-wait" id="nextWait">--</div>
    <br>
    <span class="hero-service" id="heroService"></span>
    <div class="hero-dest" id="heroDest"></div>
    <div class="hero-next-day" id="nextDay"></div>
    <div class="now-clock" id="nowClock"></div>
  </div>

  <div class="section-title">ã“ã®å¾Œã®ãƒã‚¹</div>
  <div class="upcoming" id="upcomingList"></div>

  <div class="tabs">
    <button class="tab active" data-type="weekday" onclick="switchTab('weekday')">å¹³æ—¥</button>
    <button class="tab" data-type="weekend" onclick="switchTab('weekend')">åœŸä¼‘æ—¥</button>
  </div>

  <div class="timetable-section">
    <div class="tt-header liner">æ™´æµ·ãƒ©ã‚¤ãƒŠãƒ¼<span class="dest-note">æ™´æµ·äºŒä¸ç›®ç™º</span></div>
    <div class="timetable" id="ttLiner"></div>
  </div>

  <div class="timetable-section">
    <div class="tt-header brt">æ±äº¬BRT<span class="dest-note">æ™´æµ·BRTã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç™ºï¼ˆæ™´æµ·ãƒ»è±Šæ´²ãƒ«ãƒ¼ãƒˆï¼‰</span></div>
    <div class="timetable" id="ttBrt"></div>
  </div>

  <div class="timetable-section" id="shuttleSection">
    <div class="tt-header shuttle">ä½æ°‘ãƒã‚¹<span class="dest-note">ã‚¯ãƒ­ãƒãƒ¬ã‚¸ãƒ‡ãƒ³ã‚¹ç™ºï¼ˆå¹³æ—¥ã®ã¿ï¼‰</span></div>
    <div class="timetable" id="ttShuttle"></div>
  </div>

  <div class="timetable-section" id="tiaroSection">
    <div class="tt-header tiaro">ä½æ°‘ãƒã‚¹<span class="dest-note">ãƒ†ã‚£ã‚¢ãƒ­ç™ºï¼ˆå¹³æ—¥ã®ã¿ï¼‰</span></div>
    <div class="timetable" id="ttTiaro"></div>
  </div>

  <div class="footer">æ¯ç§’è‡ªå‹•æ›´æ–°</div>
</div>

<script>
// ===== æ™´æµ·ãƒ©ã‚¤ãƒŠãƒ¼ =====
const LINER_WD = {
  7:[16,36,56], 8:[16,36], 9:[1,26,51], 10:[13,43], 11:[13,43],
  12:[13,53], 13:[33], 14:[13,53], 15:[33], 16:[3,33,59],
  17:[27,50], 18:[19,36], 19:[8]
};
const LINER_WE = {
  8:[26], 9:[26,56], 10:[36], 11:[6,36], 12:[36],
  13:[26,56], 14:[26], 15:[0,18], 16:[15,56], 17:[50],
  18:[19], 19:[8]
};
const LINER_YK_WD = new Set(['7:16','7:36','7:56','8:16','8:36','18:19','19:08']);
const LINER_YK_WE = new Set(['18:19','19:08']);

function linerDest(h, m, dayType) {
  const key = `${h}:${String(m).padStart(2,'0')}`;
  const isYk = dayType === 'weekend' ? LINER_YK_WE.has(key) : LINER_YK_WD.has(key);
  return isYk ? 'æœ‰æ¥½ç”ºé§…' : 'æ±äº¬é§…å…«é‡æ´²åŒ—å£';
}

// ===== æ±äº¬BRTï¼ˆæ™´æµ·ãƒ»è±Šæ´²ãƒ«ãƒ¼ãƒˆ â†’ æ–°æ©‹/è™ãƒé–€ãƒ’ãƒ«ã‚ºæ–¹é¢ï¼‰=====
const BRT_WD = {
  6:[4,23,43,53], 7:[4,14,24,43], 8:[3,23,43], 9:[3,23,43],
  10:[3,23,43], 11:[3,23,43], 12:[3,23,43], 13:[3,23,43],
  14:[3,23,43], 15:[3,23,43], 16:[3,23,43], 17:[3,23,43],
  18:[3,23,43], 19:[3,25,42], 20:[5,25,45], 21:[5,25,45],
  22:[7,26]
};
const BRT_WE = {
  6:[4,24,44], 7:[4,24,44], 8:[4,24,44], 9:[4,24,44],
  10:[4,24,44], 11:[4,24,44], 12:[4,24,44], 13:[4,24,44],
  14:[4,24,44], 15:[4,24,44], 16:[4,24,44], 17:[4,24,44],
  18:[4,24,44], 19:[4,27,47], 20:[7,27,47], 21:[7,27,47],
  22:[7,26]
};
const BRT_SHINBASHI_WD = new Set(['6:04','22:26']);
const BRT_SHINBASHI_WE = new Set(['6:04','22:26']);

function brtDest(h, m, dayType) {
  const key = `${h}:${String(m).padStart(2,'0')}`;
  const isShinbashi = dayType === 'weekend' ? BRT_SHINBASHI_WE.has(key) : BRT_SHINBASHI_WD.has(key);
  return isShinbashi ? 'æ–°æ©‹ æ­¢ã¾ã‚Š' : 'è™ãƒé–€ãƒ’ãƒ«ã‚º';
}

// ===== ä½æ°‘ãƒã‚¹ï¼ˆã‚¯ãƒ­ãƒãƒ¬ã‚¸ãƒ‡ãƒ³ã‚¹ç™ºãƒ»å¹³æ—¥ã®ã¿ï¼‰=====
const SHUTTLE_WD = {
  6:[30,45], 7:[0,15,30,45], 8:[0,15,30,45], 9:[0,15,45]
};
const SHUTTLE_DIRECT_WD = new Set(['6:45','7:15','7:45','8:15','8:45','9:15']);

function shuttleDest(h, m) {
  const key = `${h}:${String(m).padStart(2,'0')}`;
  return SHUTTLE_DIRECT_WD.has(key) ? 'æ±éŠ€åº§ç›´è¡Œ' : 'æœˆå³¶é§…çµŒç”±';
}

// ===== ä½æ°‘ãƒã‚¹ï¼ˆãƒ†ã‚£ã‚¢ãƒ­ç™ºãƒ»å¹³æ—¥ã®ã¿ï¼‰=====
const TIARO_WD = {
  6:[35,50], 7:[0,15,35,40], 8:[5,15,40,50], 9:[15,25,50,58]
};
const TIARO_DIRECT_WD = new Set(['6:50','7:15','7:40','8:15','8:50','9:25']);

function tiaroDest(h, m) {
  const key = `${h}:${String(m).padStart(2,'0')}`;
  return TIARO_DIRECT_WD.has(key) ? 'æ±éŠ€åº§ç›´è¡Œ' : 'æœˆå³¶é§…çµŒç”±';
}

// ===== Common =====
let activeTab = null;
let simDateTime = null; // Date object or null for live mode

function getDayType(date) {
  const d = date.getDay();
  return (d === 0 || d === 6) ? 'weekend' : 'weekday';
}

function schedToList(sched, service, dayType) {
  const times = [];
  for (const h of Object.keys(sched).map(Number).sort((a,b)=>a-b)) {
    for (const m of sched[h]) {
      let dest;
      if (service === 'liner') dest = linerDest(h, m, dayType);
      else if (service === 'brt') dest = brtDest(h, m, dayType);
      else if (service === 'tiaro') dest = tiaroDest(h, m);
      else dest = shuttleDest(h, m);
      times.push({ h, m, total: h*60+m, service, dest, dayType });
    }
  }
  return times;
}

function getAllBuses(dayType) {
  const lSched = dayType === 'weekend' ? LINER_WE : LINER_WD;
  const bSched = dayType === 'weekend' ? BRT_WE : BRT_WD;
  const all = [
    ...schedToList(lSched, 'liner', dayType),
    ...schedToList(bSched, 'brt', dayType)
  ];
  // ä½æ°‘ãƒã‚¹ã¯å¹³æ—¥ã®ã¿
  if (dayType === 'weekday') {
    all.push(...schedToList(SHUTTLE_WD, 'shuttle', dayType));
    all.push(...schedToList(TIARO_WD, 'tiaro', dayType));
  }
  all.sort((a,b) => a.total - b.total || (a.service === 'liner' ? -1 : 1));
  return all;
}

function getNextBuses(now, count) {
  const dayType = getDayType(now);
  const current = now.getHours()*60 + now.getMinutes();
  const all = getAllBuses(dayType);
  const upcoming = all.filter(t => t.total > current);

  if (upcoming.length >= count) {
    return upcoming.slice(0, count).map(t => ({ ...t, wait: t.total - current, isNextDay: false }));
  }
  // Add tomorrow's first buses
  const result = upcoming.map(t => ({ ...t, wait: t.total - current, isNextDay: false }));
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate()+1);
  const tType = getDayType(tomorrow);
  const tAll = getAllBuses(tType);
  const remaining = count - result.length;
  for (let i = 0; i < Math.min(remaining, tAll.length); i++) {
    result.push({
      ...tAll[i],
      wait: (24*60 - current) + tAll[i].total,
      isNextDay: true
    });
  }
  return result;
}

function fmt(h, m) {
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function fmtDate(d) {
  const y = d.getFullYear();
  const mon = d.getMonth() + 1;
  const day = d.getDate();
  const wd = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
  return `${y}/${mon}/${day}ï¼ˆ${wd}ï¼‰`;
}

function waitLabel(min) {
  if (min >= 60) {
    const h = Math.floor(min/60);
    const m = min % 60;
    return m > 0 ? `${h}æ™‚é–“${m}åˆ†` : `${h}æ™‚é–“`;
  }
  return `${min}åˆ†`;
}

function svcLabel(svc) {
  if (svc === 'liner') return 'ãƒ©ã‚¤ãƒŠãƒ¼';
  if (svc === 'brt') return 'BRT';
  if (svc === 'tiaro') return 'ãƒ†ã‚£ã‚¢ãƒ­';
  return 'ã‚¯ãƒ­ãƒ';
}

function svcFullLabel(svc) {
  if (svc === 'liner') return 'æ™´æµ·ãƒ©ã‚¤ãƒŠãƒ¼';
  if (svc === 'brt') return 'æ±äº¬BRT';
  if (svc === 'tiaro') return 'ä½æ°‘ãƒã‚¹ï¼ˆãƒ†ã‚£ã‚¢ãƒ­ï¼‰';
  return 'ä½æ°‘ãƒã‚¹ï¼ˆã‚¯ãƒ­ãƒï¼‰';
}

function onSimChange() {
  const dateVal = document.getElementById('simDate').value;
  const timeVal = document.getElementById('simTime').value;
  if (!dateVal && !timeVal) {
    simDateTime = null;
  } else {
    const base = dateVal ? new Date(dateVal + 'T00:00:00') : new Date();
    if (timeVal) {
      const [h, m] = timeVal.split(':').map(Number);
      base.setHours(h, m, 0, 0);
    } else {
      const now = new Date();
      base.setHours(now.getHours(), now.getMinutes(), 0, 0);
    }
    simDateTime = base;
  }
  render();
}

function clearSim() {
  simDateTime = null;
  document.getElementById('simDate').value = '';
  document.getElementById('simTime').value = '';
  render();
}

function switchTab(type) {
  activeTab = type;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.type === type);
  });
  render();
}

function render() {
  const realNow = new Date();
  const isSim = simDateTime !== null;

  // Show/hide sim UI elements
  document.getElementById('btnNow').classList.toggle('hidden', !isSim);
  document.getElementById('simBadge').classList.toggle('hidden', !isSim);

  const now = isSim ? simDateTime : realNow;

  const todayType = getDayType(now);
  const currentH = now.getHours();
  const currentM = now.getMinutes();
  const currentTotal = currentH*60 + currentM;

  document.getElementById('dayBadge').textContent =
    todayType === 'weekend' ? 'åœŸä¼‘æ—¥ãƒ€ã‚¤ãƒ¤' : 'å¹³æ—¥ãƒ€ã‚¤ãƒ¤';

  if (isSim) {
    document.getElementById('nowClock').textContent =
      `æŒ‡å®š: ${fmtDate(now)} ${fmt(currentH, currentM)}`;
  } else {
    const sec = String(realNow.getSeconds()).padStart(2,'0');
    document.getElementById('nowClock').textContent =
      `${fmtDate(realNow)} ${fmt(currentH, currentM)}:${sec}`;
  }

  // Next buses (hero + 5 upcoming)
  const buses = getNextBuses(now, 6);
  const next = buses[0] || null;

  const heroAccent = document.getElementById('heroAccent');
  const heroTime = document.getElementById('nextTime');
  const heroWait = document.getElementById('nextWait');
  const heroService = document.getElementById('heroService');
  const heroDest = document.getElementById('heroDest');
  const heroNextDay = document.getElementById('nextDay');

  if (next) {
    heroAccent.className = 'hero-accent ' + next.service;
    heroTime.textContent = fmt(next.h, next.m);
    heroWait.textContent = `ã‚ã¨ ${waitLabel(next.wait)}`;
    heroWait.className = 'hero-wait' +
      (next.wait <= 3 ? ' urgent' : next.wait <= 10 ? ' soon' : '');
    heroService.textContent = svcFullLabel(next.service);
    heroService.className = 'hero-service ' + next.service;
    heroDest.textContent = (next.service === 'shuttle' || next.service === 'tiaro') ? next.dest : next.dest + ' è¡Œã';
    heroNextDay.textContent = next.isNextDay
      ? `ï¼ˆæ˜æ—¥ ${next.dayType==='weekend'?'åœŸä¼‘æ—¥':'å¹³æ—¥'}ãƒ€ã‚¤ãƒ¤ï¼‰` : '';
  } else {
    heroAccent.className = 'hero-accent';
    heroTime.textContent = '--:--';
    heroWait.textContent = 'é‹è¡Œçµ‚äº†';
    heroWait.className = 'hero-wait';
    heroService.textContent = '';
    heroService.className = 'hero-service';
    heroDest.textContent = '';
    heroNextDay.textContent = '';
  }

  // Upcoming list (skip hero, show next 5)
  const upcoming = buses.slice(1, 6);
  const list = document.getElementById('upcomingList');
  if (upcoming.length === 0) {
    list.innerHTML = '<div class="no-bus">ã“ã®å¾Œã®ãƒã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  } else {
    list.innerHTML = upcoming.map(bus => {
      const nd = bus.isNextDay ? ' <span style="font-size:10px;color:#999">(æ˜æ—¥)</span>' : '';
      return `<div class="upcoming-item">
        <span class="upcoming-svc ${bus.service}">${svcLabel(bus.service)}</span>
        <span class="upcoming-time">${fmt(bus.h, bus.m)}</span>
        <span class="upcoming-dest">${bus.dest}${nd}</span>
        <span class="upcoming-wait">${waitLabel(bus.wait)}</span>
      </div>`;
    }).join('');
  }

  // Timetables
  const displayType = activeTab || todayType;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.type === displayType);
  });
  const isToday = displayType === todayType;

  // Find next bus per service for highlighting
  let nextLinerTotal = null;
  let nextBrtTotal = null;
  let nextShuttleTotal = null;
  let nextTiaroTotal = null;
  if (isToday) {
    const allToday = getAllBuses(todayType);
    const nl = allToday.find(t => t.service === 'liner' && t.total > currentTotal);
    const nb = allToday.find(t => t.service === 'brt' && t.total > currentTotal);
    const ns = allToday.find(t => t.service === 'shuttle' && t.total > currentTotal);
    const nt = allToday.find(t => t.service === 'tiaro' && t.total > currentTotal);
    if (nl) nextLinerTotal = nl.total;
    if (nb) nextBrtTotal = nb.total;
    if (ns) nextShuttleTotal = ns.total;
    if (nt) nextTiaroTotal = nt.total;
  }

  // Render Liner timetable
  renderTimetable(
    'ttLiner', displayType === 'weekend' ? LINER_WE : LINER_WD,
    'liner', displayType, isToday, currentH, currentTotal, nextLinerTotal,
    (h, m) => {
      const isYk = linerDest(h, m, displayType) === 'æœ‰æ¥½ç”ºé§…';
      return { special: isYk, tooltip: isYk ? 'æœ‰æ¥½ç”ºé§…è¡Œã' : 'æ±äº¬é§…å…«é‡æ´²åŒ—å£è¡Œã' };
    },
    [
      { color: '#1a73e8', border: false, label: 'æ±äº¬é§…å…«é‡æ´²åŒ—å£' },
      { color: '#e57373', border: true, label: 'æœ‰æ¥½ç”ºé§…' }
    ]
  );

  // Render BRT timetable
  renderTimetable(
    'ttBrt', displayType === 'weekend' ? BRT_WE : BRT_WD,
    'brt', displayType, isToday, currentH, currentTotal, nextBrtTotal,
    (h, m) => {
      const isShinbashi = brtDest(h, m, displayType) === 'æ–°æ©‹ æ­¢ã¾ã‚Š';
      return { special: isShinbashi, tooltip: isShinbashi ? 'æ–°æ©‹æ­¢ã¾ã‚Š' : 'è™ãƒé–€ãƒ’ãƒ«ã‚ºè¡Œã' };
    },
    [
      { color: '#00897b', border: false, label: 'è™ãƒé–€ãƒ’ãƒ«ã‚º' },
      { color: '#e57373', border: true, label: 'æ–°æ©‹æ­¢ã¾ã‚Š' }
    ]
  );

  // Render Shuttle timetable (weekday only)
  const shuttleSection = document.getElementById('shuttleSection');
  const tiaroSection = document.getElementById('tiaroSection');
  if (displayType === 'weekend') {
    shuttleSection.style.display = 'none';
    tiaroSection.style.display = 'none';
  } else {
    shuttleSection.style.display = '';
    renderTimetable(
      'ttShuttle', SHUTTLE_WD,
      'shuttle', displayType, isToday, currentH, currentTotal, nextShuttleTotal,
      (h, m) => {
        const isDirect = shuttleDest(h, m) === 'æ±éŠ€åº§ç›´è¡Œ';
        return { special: isDirect, tooltip: isDirect ? 'æ±éŠ€åº§ç›´è¡Œ' : 'æœˆå³¶é§…çµŒç”±' };
      },
      [
        { color: '#e67c00', border: false, label: 'æœˆå³¶é§…çµŒç”±' },
        { color: '#e57373', border: true, label: 'æ±éŠ€åº§ç›´è¡Œ' }
      ]
    );

    tiaroSection.style.display = '';
    renderTimetable(
      'ttTiaro', TIARO_WD,
      'tiaro', displayType, isToday, currentH, currentTotal, nextTiaroTotal,
      (h, m) => {
        const isDirect = tiaroDest(h, m) === 'æ±éŠ€åº§ç›´è¡Œ';
        return { special: isDirect, tooltip: isDirect ? 'æ±éŠ€åº§ç›´è¡Œ' : 'æœˆå³¶é§…çµŒç”±' };
      },
      [
        { color: '#e67c00', border: false, label: 'æœˆå³¶é§…çµŒç”±' },
        { color: '#e57373', border: true, label: 'æ±éŠ€åº§ç›´è¡Œ' }
      ]
    );
  }
}

function renderTimetable(id, sched, service, displayType, isToday, currentH, currentTotal, nextTotal, infoFn, legendItems) {
  const hours = Object.keys(sched).map(Number).sort((a,b)=>a-b);
  const nextCls = `next-${service}`;
  const currentCls = `current-${service}`;

  const legend = `<div class="legend">${legendItems.map(li =>
    `<span class="legend-item"><span class="legend-dot" style="background:${li.color}${li.border ? ';border:2px solid #c62828' : ''}"></span> ${li.label}</span>`
  ).join('')}</div>`;

  document.getElementById(id).innerHTML = legend + hours.map(hour => {
    const isPast = isToday && hour < currentH;
    const isCurrent = isToday && hour === currentH;
    const rowClass = isPast ? 'tt-row past' : isCurrent ? `tt-row ${currentCls}` : 'tt-row';

    const mins = sched[hour].map(m => {
      const t = hour*60+m;
      const info = infoFn(hour, m);
      let cls = 'tt-min';
      if (isToday && t <= currentTotal) cls += ' past';
      else if (nextTotal !== null && t === nextTotal) cls += ` ${nextCls}`;
      else cls += ' future';
      if (info.special) cls += ' special';
      return `<span class="${cls}" title="${info.tooltip}">${String(m).padStart(2,'0')}</span>`;
    }).join('');

    return `<div class="${rowClass}">
      <span class="tt-hour ${service}">${hour}</span>
      <div class="tt-minutes">${mins}</div>
    </div>`;
  }).join('');
}

render();
setInterval(render, 1000);
activeTab = null;
</script>
<script>

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½
    class DarkModeManager {
      constructor() {
        this.init();
      }
      
      init() {
        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ç¢ºèª
        const savedTheme = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme) {
          this.setTheme(savedTheme);
        } else if (systemDark) {
          this.setTheme('dark');
        }
        
        // åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³è¿½åŠ 
        this.createToggleButton();
        
        // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´ã‚’ç›£è¦–
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          if (!localStorage.getItem('theme')) {
            this.setTheme(e.matches ? 'dark' : 'light');
          }
        });
      }
      
      setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        this.updateToggleButton(theme);
      }
      
      toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        this.setTheme(newTheme);
      }
      
      createToggleButton() {
        const button = document.createElement('button');
        button.className = 'theme-toggle';
        button.innerHTML = 'ğŸŒ™';
        button.title = 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ';
        button.onclick = () => this.toggleTheme();
        document.body.appendChild(button);
        this.toggleButton = button;
      }
      
      updateToggleButton(theme) {
        if (this.toggleButton) {
          this.toggleButton.innerHTML = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
          this.toggleButton.title = theme === 'dark' ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';
        }
      }
    }
    
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      new DarkModeManager();
    });
    
</script>
<script>

    // ãŠæ°—ã«å…¥ã‚Šåœç•™æ‰€æ©Ÿèƒ½
    class FavoritesManager {
      constructor() {
        this.favorites = JSON.parse(localStorage.getItem('busFavorites') || '[]');
        this.init();
      }
      
      init() {
        this.createFavoritesPanel();
        this.renderFavorites();
        this.addFavoriteButtons();
      }
      
      createFavoritesPanel() {
        // æ—¢å­˜ã®è¦ç´ ã®å¾Œã«ãŠæ°—ã«å…¥ã‚Šãƒ‘ãƒãƒ«ã‚’æŒ¿å…¥
        const container = document.querySelector('.container') || document.body;
        const panel = document.createElement('div');
        panel.innerHTML = `
    <!-- ãŠæ°—ã«å…¥ã‚Šåœç•™æ‰€ãƒ‘ãƒãƒ« -->
    <div class="favorites-panel" id="favoritesPanel">
      <div class="favorites-header">
        <h5>â­ ãŠæ°—ã«å…¥ã‚Šåœç•™æ‰€</h5>
        <button class="btn btn-sm btn-outline-secondary" id="editFavoritesBtn">ç·¨é›†</button>
      </div>
      <div class="favorites-list" id="favoritesList">
        <!-- ãŠæ°—ã«å…¥ã‚ŠãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
    </div>
    `;
        container.insertBefore(panel.firstElementChild, container.firstElementChild);
        
        // ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById('editFavoritesBtn').addEventListener('click', () => {
          this.toggleEditMode();
        });
        
        // ãŠæ°—ã«å…¥ã‚ŠãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒ‘ãƒãƒ«è¡¨ç¤º
        if (this.favorites.length > 0) {
          document.getElementById('favoritesPanel').classList.add('show');
        }
      }
      
      renderFavorites() {
        const list = document.getElementById('favoritesList');
        if (!list) return;
        
        list.innerHTML = this.favorites.map(fav => `
          <a href="#" class="favorite-item" data-stop="${fav.id}">
            ${fav.name}
            <span class="remove-btn" data-remove="${fav.id}" style="display: none;">âœ•</span>
          </a>
        `).join('');
        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        list.querySelectorAll('.favorite-item').forEach(item => {
          item.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
              this.removeFavorite(e.target.dataset.remove);
            } else {
              this.selectStop(item.dataset.stop);
            }
          });
        });
      }
      
      addFavoriteButtons() {
        // åœç•™æ‰€é¸æŠã‚¨ãƒªã‚¢ã«ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const stopSelects = document.querySelectorAll('select, input');
        stopSelects.forEach(select => {
          if (select.id && select.id.includes('stop') || select.className.includes('stop')) {
            this.addFavoriteButton(select);
          }
        });
      }
      
      addFavoriteButton(element) {
        const container = element.parentElement;
        if (container.style.position !== 'relative') {
          container.style.position = 'relative';
        }
        
        const button = document.createElement('button');
        button.className = 'add-favorite-btn';
        button.innerHTML = 'â­';
        button.title = 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ';
        button.onclick = (e) => {
          e.preventDefault();
          this.addCurrentStop();
        };
        
        container.appendChild(button);
      }
      
      addCurrentStop() {
        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹åœç•™æ‰€ã‚’å–å¾—
        const currentStop = this.getCurrentStopInfo();
        if (currentStop && !this.favorites.find(f => f.id === currentStop.id)) {
          this.favorites.push(currentStop);
          this.saveFavorites();
          this.renderFavorites();
          
          // ãƒ‘ãƒãƒ«è¡¨ç¤º
          document.getElementById('favoritesPanel').classList.add('show');
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          this.showMessage(`â­ ${currentStop.name} ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ`);
        }
      }
      
      getCurrentStopInfo() {
        // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã‹ã‚‰åœç•™æ‰€æƒ…å ±ã‚’å–å¾—ï¼ˆã‚¢ãƒ—ãƒªã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
        return {
          id: Date.now().toString(),
          name: 'ç¾åœ¨ã®åœç•™æ‰€' // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã«åˆã‚ã›ã¦ä¿®æ­£
        };
      }
      
      removeFavorite(id) {
        this.favorites = this.favorites.filter(f => f.id !== id);
        this.saveFavorites();
        this.renderFavorites();
        
        if (this.favorites.length === 0) {
          document.getElementById('favoritesPanel').classList.remove('show');
        }
      }
      
      selectStop(id) {
        const favorite = this.favorites.find(f => f.id === id);
        if (favorite) {
          // é¸æŠã•ã‚ŒãŸåœç•™æ‰€ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¢ãƒ—ãƒªã«åˆã‚ã›ã¦å®Ÿè£…ï¼‰
          this.showMessage(`ğŸšŒ ${favorite.name} ã®æ™‚åˆ»è¡¨ã‚’è¡¨ç¤º`);
        }
      }
      
      toggleEditMode() {
        const removeButtons = document.querySelectorAll('.remove-btn');
        const isEditing = removeButtons[0]?.style.display !== 'none';
        
        removeButtons.forEach(btn => {
          btn.style.display = isEditing ? 'none' : 'inline';
        });
        
        const editBtn = document.getElementById('editFavoritesBtn');
        editBtn.textContent = isEditing ? 'ç·¨é›†' : 'å®Œäº†';
      }
      
      saveFavorites() {
        localStorage.setItem('busFavorites', JSON.stringify(this.favorites));
      }
      
      showMessage(text) {
        // ç°¡æ˜“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        const msg = document.createElement('div');
        msg.style.cssText = `
          position: fixed; top: 80px; right: 20px; z-index: 1001;
          background: var(--accent-color); color: white;
          padding: 10px 15px; border-radius: 5px;
          font-size: 14px; opacity: 0; transition: opacity 0.3s ease;
        `;
        msg.textContent = text;
        document.body.appendChild(msg);
        
        setTimeout(() => msg.style.opacity = '1', 10);
        setTimeout(() => {
          msg.style.opacity = '0';
          setTimeout(() => msg.remove(), 300);
        }, 3000);
      }
    }
    
    // ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => new FavoritesManager(), 100);
    });
    
</script>
<script>

  // é€šçŸ¥æ©Ÿèƒ½
  class NotificationManager {
    constructor() {
      this.notifications = JSON.parse(localStorage.getItem('busNotifications') || '[]');
      this.permission = Notification.permission;
      this.init();
    }
    
    async init() {
      this.createNotificationUI();
      this.checkPermission();
      this.startScheduler();
      this.updateBadge();
    }
    
    async checkPermission() {
      if (this.permission === 'default') {
        this.permission = await Notification.requestPermission();
      }
    }
    
    createNotificationUI() {
      // é€šçŸ¥åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'notify-toggle';
      toggleBtn.innerHTML = 'ğŸ””';
      toggleBtn.title = 'é€šçŸ¥è¨­å®š';
      toggleBtn.onclick = () => this.togglePanel();
      document.body.appendChild(toggleBtn);
      this.toggleBtn = toggleBtn;
      
      // é€šçŸ¥ãƒ‘ãƒãƒ«
      const panel = document.createElement('div');
      panel.className = 'notification-panel';
      panel.id = 'notificationPanel';
      panel.innerHTML = `
        <div class="notification-header">
          <h6>ğŸ”” ãƒã‚¹é€šçŸ¥è¨­å®š</h6>
          <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.classList.remove('show')">âœ•</button>
        </div>
        
        <div class="notification-setting">
          <label>é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
          <input type="checkbox" id="enableNotifications" ${this.isEnabled() ? 'checked' : ''}>
        </div>
        
        <div class="notification-setting">
          <label>ãƒã‚¹æ¥è¿‘é€šçŸ¥ (åˆ†å‰)</label>
          <select id="notifyMinutes" class="time-input">
            <option value="5">5åˆ†å‰</option>
            <option value="10" selected>10åˆ†å‰</option>
            <option value="15">15åˆ†å‰</option>
            <option value="20">20åˆ†å‰</option>
          </select>
        </div>
        
        <div class="notification-setting">
          <label>æ™‚åˆ»æŒ‡å®šé€šçŸ¥</label>
          <div class="time-input-group">
            <input type="time" id="customNotifyTime" class="time-input">
            <button class="btn btn-sm btn-primary" onclick="notificationManager.addCustomNotification()">è¿½åŠ </button>
          </div>
        </div>
        
        <div id="customNotificationsList"></div>
        
        <div class="notification-setting" style="margin-top: 15px;">
          <button class="btn btn-sm btn-success" onclick="notificationManager.testNotification()">ãƒ†ã‚¹ãƒˆé€šçŸ¥</button>
          <button class="btn btn-sm btn-outline-danger" onclick="notificationManager.clearAll()">å…¨ã¦å‰Šé™¤</button>
        </div>
      `;
      
      document.body.appendChild(panel);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('enableNotifications').onchange = (e) => {
        this.setEnabled(e.target.checked);
      };
      
      document.getElementById('notifyMinutes').onchange = (e) => {
        this.setNotifyMinutes(parseInt(e.target.value));
      };
      
      this.renderCustomNotifications();
    }
    
    togglePanel() {
      const panel = document.getElementById('notificationPanel');
      panel.classList.toggle('show');
    }
    
    isEnabled() {
      return localStorage.getItem('busNotificationsEnabled') === 'true';
    }
    
    setEnabled(enabled) {
      localStorage.setItem('busNotificationsEnabled', enabled);
      if (enabled) {
        this.checkPermission();
      }
      this.updateBadge();
    }
    
    setNotifyMinutes(minutes) {
      localStorage.setItem('busNotifyMinutes', minutes);
    }
    
    getNotifyMinutes() {
      return parseInt(localStorage.getItem('busNotifyMinutes') || '10');
    }
    
    addCustomNotification() {
      const timeInput = document.getElementById('customNotifyTime');
      const time = timeInput.value;
      
      if (time) {
        const notification = {
          id: Date.now(),
          time: time,
          enabled: true,
          repeat: 'daily'
        };
        
        this.notifications.push(notification);
        this.saveNotifications();
        this.renderCustomNotifications();
        this.updateBadge();
        
        timeInput.value = '';
        this.showToast(`â° ${time} ã®é€šçŸ¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      }
    }
    
    removeNotification(id) {
      this.notifications = this.notifications.filter(n => n.id !== id);
      this.saveNotifications();
      this.renderCustomNotifications();
      this.updateBadge();
    }
    
    renderCustomNotifications() {
      const list = document.getElementById('customNotificationsList');
      if (!list) return;
      
      list.innerHTML = this.notifications.map(notif => `
        <div class="notification-setting" style="font-size: 14px;">
          <span>â° ${notif.time}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="notificationManager.removeNotification(${notif.id})">å‰Šé™¤</button>
        </div>
      `).join('');
    }
    
    saveNotifications() {
      localStorage.setItem('busNotifications', JSON.stringify(this.notifications));
    }
    
    updateBadge() {
      const hasActive = this.isEnabled() && (this.notifications.length > 0);
      
      if (hasActive && !this.toggleBtn.querySelector('.notify-badge')) {
        const badge = document.createElement('span');
        badge.className = 'notify-badge';
        badge.textContent = this.notifications.length;
        this.toggleBtn.appendChild(badge);
      } else if (!hasActive && this.toggleBtn.querySelector('.notify-badge')) {
        this.toggleBtn.querySelector('.notify-badge').remove();
      }
    }
    
    startScheduler() {
      // 1åˆ†ã”ã¨ã«é€šçŸ¥ãƒã‚§ãƒƒã‚¯
      setInterval(() => {
        if (this.isEnabled()) {
          this.checkScheduledNotifications();
        }
      }, 60000); // 1åˆ†
    }
    
    checkScheduledNotifications() {
      const now = new Date();
      const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                         now.getMinutes().toString().padStart(2, '0');
      
      this.notifications.forEach(notif => {
        if (notif.enabled && notif.time === currentTime) {
          this.sendNotification('ğŸšŒ ãƒã‚¹æ™‚åˆ»è¡¨', {
            body: `${notif.time} ã®é€šçŸ¥æ™‚åˆ»ã§ã™ã€‚æ¬¡ã®ãƒã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
            icon: '/apple-touch-icon.png',
            tag: 'bus-scheduled-' + notif.id
          });
        }
      });
    }
    
    async sendNotification(title, options = {}) {
      if (this.permission === 'granted') {
        try {
          const notification = new Notification(title, {
            icon: '/apple-touch-icon.png',
            badge: '/apple-touch-icon.png',
            ...options
          });
          
          notification.onclick = () => {
            window.focus();
            notification.close();
          };
          
          // 5ç§’å¾Œã«è‡ªå‹•é–‰ã˜
          setTimeout(() => notification.close(), 5000);
          
        } catch (error) {
          console.log('é€šçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
          this.showToast('é€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    }
    
    testNotification() {
      this.sendNotification('ğŸšŒ ãƒ†ã‚¹ãƒˆé€šçŸ¥', {
        body: 'ãƒã‚¹é€šçŸ¥ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼',
        tag: 'bus-test'
      });
      this.showToast('ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
    }
    
    showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'notification-toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    clearAll() {
      if (confirm('å…¨ã¦ã®é€šçŸ¥è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        this.notifications = [];
        this.saveNotifications();
        this.renderCustomNotifications();
        this.updateBadge();
        this.showToast('é€šçŸ¥è¨­å®šã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    }
    
    // æ¬¡ã®ãƒã‚¹æ¥è¿‘é€šçŸ¥ï¼ˆãƒã‚¹æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã¨é€£æºï¼‰
    notifyUpcomingBus(busTime, minutesAway) {
      const notifyMinutes = this.getNotifyMinutes();
      
      if (this.isEnabled() && minutesAway <= notifyMinutes) {
        this.sendNotification('ğŸšŒ ãƒã‚¹æ¥è¿‘ä¸­', {
          body: `${busTime} ã®ãƒã‚¹ãŒç´„ ${minutesAway} åˆ†å¾Œã«åˆ°ç€ã—ã¾ã™`,
          tag: 'bus-approaching-' + busTime.replace(':', '')
        });
      }
    }
  }
  
  // é€šçŸ¥æ©Ÿèƒ½åˆæœŸåŒ–
  let notificationManager;
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      notificationManager = new NotificationManager();
    }, 200);
  });
  
</script>
<script>

  // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ©Ÿèƒ½
  class AccessibilityManager {
    constructor() {
      this.settings = JSON.parse(localStorage.getItem('accessibilitySettings') || '{}');
      this.synthesis = window.speechSynthesis;
      this.init();
    }
    
    init() {
      this.createAccessibilityUI();
      this.setupKeyboardNavigation();
      this.applySettings();
      this.addARIALabels();
      this.setupSpeechSupport();
    }
    
    createAccessibilityUI() {
      // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'accessibility-toggle';
      toggleBtn.innerHTML = 'â™¿';
      toggleBtn.title = 'ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š';
      toggleBtn.setAttribute('aria-label', 'ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®šã‚’é–‹ã');
      toggleBtn.onclick = () => this.togglePanel();
      document.body.appendChild(toggleBtn);
      
      // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ‘ãƒãƒ«
      const panel = document.createElement('div');
      panel.className = 'accessibility-panel';
      panel.id = 'accessibilityPanel';
      panel.setAttribute('role', 'dialog');
      panel.setAttribute('aria-labelledby', 'accessibility-title');
      panel.innerHTML = `
        <div class="accessibility-header">
          <h5 id="accessibility-title">â™¿ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š</h5>
          <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.classList.remove('show')" aria-label="è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹">âœ•</button>
        </div>
        
        <div class="accessibility-setting">
          <label for="largeText">å¤§ããªæ–‡å­—</label>
          <input type="checkbox" id="largeText" ${this.settings.largeText ? 'checked' : ''}>
        </div>
        
        <div class="accessibility-setting">
          <label for="highContrast">é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ</label>
          <input type="checkbox" id="highContrast" ${this.settings.highContrast ? 'checked' : ''}>
        </div>
        
        <div class="accessibility-setting">
          <label for="reduceMotion">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šæ¸›</label>
          <input type="checkbox" id="reduceMotion" ${this.settings.reduceMotion ? 'checked' : ''}>
        </div>
        
        <div class="accessibility-setting">
          <label for="keyboardNavigation">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</label>
          <input type="checkbox" id="keyboardNavigation" ${this.settings.keyboardNavigation ? 'checked' : ''}>
        </div>
        
        <div class="accessibility-setting">
          <label for="speechEnabled">éŸ³å£°èª­ã¿ä¸Šã’</label>
          <input type="checkbox" id="speechEnabled" ${this.settings.speechEnabled ? 'checked' : ''}>
        </div>
        
        <div class="accessibility-setting">
          <label for="speechRate">èª­ã¿ä¸Šã’é€Ÿåº¦</label>
          <select id="speechRate">
            <option value="0.5" ${this.settings.speechRate === 0.5 ? 'selected' : ''}>ã‚†ã£ãã‚Š</option>
            <option value="1" ${(this.settings.speechRate || 1) === 1 ? 'selected' : ''}>æ™®é€š</option>
            <option value="1.5" ${this.settings.speechRate === 1.5 ? 'selected' : ''}>æ—©ã„</option>
            <option value="2" ${this.settings.speechRate === 2 ? 'selected' : ''}>ã¨ã¦ã‚‚æ—©ã„</option>
          </select>
        </div>
        
        <div class="accessibility-setting">
          <button class="btn btn-sm btn-success" onclick="accessibilityManager.testSpeech()">éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
          <button class="btn btn-sm btn-outline-danger" onclick="accessibilityManager.resetSettings()">è¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      `;
      
      document.body.appendChild(panel);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      this.setupEventListeners();
    }
    
    setupEventListeners() {
      const settings = ['largeText', 'highContrast', 'reduceMotion', 'keyboardNavigation', 'speechEnabled'];
      
      settings.forEach(setting => {
        const element = document.getElementById(setting);
        if (element) {
          element.onchange = (e) => {
            this.updateSetting(setting, e.target.checked);
          };
        }
      });
      
      const speechRate = document.getElementById('speechRate');
      if (speechRate) {
        speechRate.onchange = (e) => {
          this.updateSetting('speechRate', parseFloat(e.target.value));
        };
      }
    }
    
    updateSetting(key, value) {
      this.settings[key] = value;
      localStorage.setItem('accessibilitySettings', JSON.stringify(this.settings));
      this.applySettings();
    }
    
    applySettings() {
      const body = document.body;
      
      // å¤§ããªæ–‡å­—
      if (this.settings.largeText) {
        body.classList.add('large-text');
      } else {
        body.classList.remove('large-text');
      }
      
      // é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ
      if (this.settings.highContrast) {
        body.classList.add('high-contrast');
      } else {
        body.classList.remove('high-contrast');
      }
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‰Šæ¸›
      if (this.settings.reduceMotion) {
        body.classList.add('reduce-motion');
      } else {
        body.classList.remove('reduce-motion');
      }
      
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
      if (this.settings.keyboardNavigation) {
        body.classList.add('keyboard-navigation');
        this.enableKeyboardNavigation();
      } else {
        body.classList.remove('keyboard-navigation');
      }
    }
    
    setupKeyboardNavigation() {
      // Tab ã‚­ãƒ¼ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ã‚’æ”¹å–„
      document.addEventListener('keydown', (e) => {
        if (!this.settings.keyboardNavigation) return;
        
        switch(e.key) {
          case 'Tab':
            this.highlightFocusableElements();
            break;
          case 'Enter':
          case ' ':
            if (e.target.classList.contains('focusable')) {
              e.target.click();
            }
            break;
          case 'Escape':
            this.closeAllPanels();
            break;
        }
      });
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ãªè¦ç´ ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      this.markFocusableElements();
    }
    
    markFocusableElements() {
      const focusableSelectors = [
        'button', 'input', 'select', 'textarea', 'a[href]',
        '[tabindex]:not([tabindex="-1"])'
      ];
      
      focusableSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
          el.classList.add('focusable');
        });
      });
    }
    
    enableKeyboardNavigation() {
      // ã‚ˆã‚Šç›®ç«‹ã¤ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¡¨ç¤º
      const style = document.createElement('style');
      style.textContent = `
        .keyboard-navigation .focusable:focus {
          outline: 3px solid var(--accent-color) !important;
          outline-offset: 2px !important;
          box-shadow: 0 0 10px rgba(0, 123, 255, 0.3) !important;
        }
      `;
      document.head.appendChild(style);
    }
    
    addARIALabels() {
      // æ—¢å­˜ã®è¦ç´ ã«ARIAå±æ€§ã‚’è¿½åŠ 
      setTimeout(() => {
        const buttons = document.querySelectorAll('button:not([aria-label])');
        buttons.forEach((btn, index) => {
          if (!btn.getAttribute('aria-label')) {
            const text = btn.textContent.trim() || btn.innerHTML.trim();
            if (text) {
              btn.setAttribute('aria-label', text);
            }
          }
        });
        
        // æ™‚åˆ»è¡¨ç¤ºã‚¨ãƒªã‚¢ã«aria-liveå±æ€§è¿½åŠ 
        const timeElements = document.querySelectorAll('.time, .next-bus, .current-time');
        timeElements.forEach(el => {
          el.setAttribute('aria-live', 'polite');
          el.setAttribute('aria-atomic', 'true');
        });
        
        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã«roleå±æ€§
        const main = document.querySelector('main') || document.querySelector('.container');
        if (main && !main.getAttribute('role')) {
          main.setAttribute('role', 'main');
        }
        
      }, 500);
    }
    
    setupSpeechSupport() {
      if (!this.synthesis) return;
      
      // éŸ³å£°èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ã‚’æ™‚åˆ»è¡¨ç¤ºã®è¿‘ãã«è¿½åŠ 
      setTimeout(() => {
        const timeElements = document.querySelectorAll('.next-bus, .bus-time');
        timeElements.forEach(el => {
          const speakBtn = document.createElement('button');
          speakBtn.className = 'speak-button';
          speakBtn.innerHTML = 'ğŸ”Š';
          speakBtn.title = 'éŸ³å£°ã§èª­ã¿ä¸Šã’';
          speakBtn.setAttribute('aria-label', 'æ™‚åˆ»ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’');
          speakBtn.onclick = (e) => {
            e.stopPropagation();
            this.speak(el.textContent);
          };
          el.appendChild(speakBtn);
        });
      }, 1000);
    }
    
    speak(text) {
      if (!this.settings.speechEnabled || !this.synthesis) return;
      
      // é€²è¡Œä¸­ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
      this.synthesis.cancel();
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = this.settings.speechRate || 1;
      utterance.lang = 'ja-JP';
      
      this.synthesis.speak(utterance);
    }
    
    testSpeech() {
      this.speak('éŸ³å£°èª­ã¿ä¸Šã’ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ãƒã‚¹æ™‚åˆ»è¡¨ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
    }
    
    togglePanel() {
      const panel = document.getElementById('accessibilityPanel');
      const isOpen = panel.classList.contains('show');
      
      if (isOpen) {
        panel.classList.remove('show');
        panel.setAttribute('aria-hidden', 'true');
      } else {
        panel.classList.add('show');
        panel.setAttribute('aria-hidden', 'false');
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æœ€åˆã®è¨­å®šé …ç›®ã«ç§»å‹•
        const firstInput = panel.querySelector('input');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 300);
        }
      }
    }
    
    closeAllPanels() {
      document.querySelectorAll('.panel.show, .notification-panel.show, .accessibility-panel.show').forEach(panel => {
        panel.classList.remove('show');
        panel.setAttribute('aria-hidden', 'true');
      });
    }
    
    resetSettings() {
      if (confirm('ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) {
        this.settings = {};
        localStorage.removeItem('accessibilitySettings');
        location.reload();
      }
    }
    
    // è‡ªå‹•èª­ã¿ä¸Šã’æ©Ÿèƒ½ï¼ˆé‡è¦ãªæƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ï¼‰
    announceUpdate(message) {
      if (this.settings.speechEnabled) {
        setTimeout(() => this.speak(message), 500);
      }
    }
  }
  
  // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ©Ÿèƒ½åˆæœŸåŒ–
  let accessibilityManager;
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      accessibilityManager = new AccessibilityManager();
    }, 300);
  });
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦è¿½åŠ ï¼ˆä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ç”¨å¯èƒ½ï¼‰
  window.announceToScreenReader = function(message) {
    if (accessibilityManager) {
      accessibilityManager.announceUpdate(message);
    }
  };
  
</script>
</body>
</html>
